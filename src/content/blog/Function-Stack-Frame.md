---
draft: true
title: "[ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»] è¶…è¯¦è§£å‡½æ•°æ ˆå¸§"
pubDate: "2022-03-31"
description: "ç¨‹åºè¿è¡ŒèƒŒåçš„æœºåˆ¶å’Œç”±æ¥, å¯ä»¥çœ‹ä½œæ˜¯ç¨‹åºå‘˜çš„ä¸€ç§â€œè‡ªæˆ‘ä¿®å…»â€ã€‚------ ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» â€œé“¾æ¥ã€è£…è½½ä¸åº“â€"
image: https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/cover.webp
tags:
    - ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»
    - å†…å­˜
---

åœ¨é˜…è¯»è¿™ç¯‡æ–‡ç« ä¹‹å‰, è¯·æ€è€ƒä¸€ä¸‹å¯¹äºä¸‹é¢çš„è¿™äº›é—®é¢˜, ä½ æœ‰ä¸€ä¸ªå‡†ç¡®æ¸…æ™°çš„è®¤çŸ¥å—ï¼Ÿ

1. ä»€ä¹ˆæ˜¯å‡½æ•°æ ˆå¸§ï¼Ÿ
2. ç¨‹åºä¸­çš„å±€éƒ¨å˜é‡, æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ
3. ä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡ä¸åˆå§‹åŒ–ä¼šæ˜¯éšæœºå€¼ï¼Ÿ
4. å‡½æ•°ä¼ å‚, ç©¶ç«Ÿæ˜¯å¦‚ä½•ä¼ å‚çš„ï¼Ÿ
5. å‡½æ•°çš„å½¢å‚å’Œå®å‚å­˜åœ¨ä»€ä¹ˆå…³ç³»ï¼Ÿ
6. å‡½æ•°æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ
7. å‡½æ•°è¢«è°ƒç”¨ä¹‹åæ˜¯å¦‚ä½•è¿”å›çš„ï¼Ÿ

å¦‚æœæ²¡æœ‰, è¯·å°è¯•é˜…è¯»ã€åˆ†æã€ç†è§£æœ¬ç¯‡æ–‡ç« ã€‚
è¯»æ‡‚æœ¬ç¯‡æ–‡ç« å°†ä¼šæå‡ä½ çš„â€œè‡ªæˆ‘ä¿®å…»â€ã€‚

> `ç¨‹åºè¿è¡ŒèƒŒåçš„æœºåˆ¶å’Œç”±æ¥, å¯ä»¥çœ‹ä½œæ˜¯ç¨‹åºå‘˜çš„ä¸€ç§â€œè‡ªæˆ‘ä¿®å…»â€ã€‚`
> **------ ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» â€œé“¾æ¥ã€è£…è½½ä¸åº“â€**
---

# æ ˆä¸æ ˆå¸§

## ä»€ä¹ˆæ˜¯æ ˆï¼Ÿ

åœ¨æ“ä½œç³»ç»Ÿä¸­, æ ˆæ˜¯ä¸€ä¸ªåŠ¨æ€å†…å­˜åŒºåŸŸã€‚

å‡½æ•°çš„ä¸­çš„å±€éƒ¨å˜é‡, éƒ½å­˜æ”¾åœ¨å†…å­˜çš„æ ˆåŒºä¸­ã€‚

æ ˆåŒºçš„ä½¿ç”¨, å’Œæ•°æ®ç»“æ„ä¸­çš„æ ˆä½¿ç”¨è§„åˆ™ç›¸ä¼¼: 

å‹æ ˆã€å‡ºæ ˆã€å…ˆè¿›åå‡ºã€‚

æ ˆåŒºæ€»æ˜¯å…ˆä½¿ç”¨é«˜åœ°å€, å†ä½¿ç”¨ä½åœ°å€, å³æ ˆåŒºçš„ä½¿ç”¨æ˜¯ `ä»é«˜åœ°å€å‘ä½åœ°å€å»¶ä¼¸` çš„ã€‚

## ä»€ä¹ˆæ˜¯æ ˆå¸§ï¼Ÿ
ä»é€»è¾‘ä¸Šè®², æ ˆå¸§å°±æ˜¯ä¸€ä¸ªå‡½æ•°æ‰§è¡Œçš„ç¯å¢ƒã€‚

æ ˆä¼šä¿å­˜ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ‰€éœ€è¦çš„ç»´æŠ¤ä¿¡æ¯, ä¿å­˜è¿™äº›ä¿¡æ¯æ‰€ç”¨çš„ä¿¡æ¯ç©ºé—´, å¸¸è¢«ç§°ä¸º `å‡½æ•°æ ˆå¸§`ã€‚

æ¯ä¸€ä¸ªå‡½æ•°çš„è°ƒç”¨, éƒ½ä¼šåˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„æ ˆå¸§ã€‚

ç»´æŠ¤å‡½æ•°æ ˆå¸§, éœ€è¦ç”¨ `ä¸¤ä¸ªå¯„å­˜å™¨` æ¥è®°å½•å‡½æ•°æ ˆå¸§çš„å¤§å°, ä¹Ÿå¯ä»¥å« åˆ’å®šå‡½æ•°æ´»åŠ¨è®°å½•çš„èŒƒå›´ , è¿™ä¸¤ä¸ªå¯„å­˜å™¨å­˜æ”¾çš„æ˜¯åœ°å€, ä¸¤ä¸ªåœ°å€ä¹‹é—´, å°±æ˜¯å‡½æ•°çš„æ ˆå¸§å¤§å°: 
1. å¯„å­˜å™¨ `ebp`: æ ˆåº•æŒ‡é’ˆ

  æŒ‡å‘ç»´æŠ¤æ ˆå¸§çš„é«˜åœ°å€.

2. å¯„å­˜å™¨ `esp`: æ ˆé¡¶æŒ‡é’ˆ

  æŒ‡å‘ç»´æŠ¤çš„æ ˆå¸§çš„ä½åœ°å€, ä¼šéšæ¯æ¬¡å‹æ ˆè‡ªåŠ¨å‘ä½åœ°å€å»¶ä¼¸.

# æ ˆå¸§æ˜¯å¦‚ä½•åˆ›å»ºçš„?
> 	ä»¥ä¸‹å‡åœ¨Windowså¹³å°, VS2013ç¼–è¯‘ç¯å¢ƒä¸‹æ¼”ç¤º
>																		
> 	ä¸åŒå¹³å°, ä¸åŒç¼–è¯‘ç¯å¢ƒä¸‹çš„æ ˆå¸§æ“ä½œå¯èƒ½ä¼šæœ‰å·®å¼‚, ä½†æ˜¯é€»è¾‘ç›¸é€šã€‚

åˆ›å»ºä¸€ä¸ªæœ€ç®€å•çš„å¯ä»¥è§‚å¯Ÿå‡½æ•°æ ˆå¸§çš„ç¨‹åº

ï¼ˆæ­¥éª¤åˆ’åˆ†è¶Šç»†, å‡½æ•°æ ˆå¸§è§‚å¯Ÿè¶Šå®¹æ˜“ï¼‰: 

```cpp
#include <stdio.h>

int Add(int x, int y)
{
	int z = 0;
	z = x + y;

	return z;
}

int main()
{
	int a = 10;
	int b = 20;
	int c = 0;
	c = Add(a, b);

	return 0;
}
```
åœ¨å¯¹ä»£ç è¿›è¡Œè°ƒè¯•çš„æ—¶å€™, å¯¹å‡½æ•°æ ˆå¸§è°ƒç”¨è¿›è¡ŒæŸ¥çœ‹, æ­¤æ—¶è°ƒç”¨ mian å‡½æ•°æ ˆå¸§:

![SF_Main](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/SF_Main.webp)

å°†å…‰æ ‡ç»§ç»­å‘åèµ°, èµ°åˆ° `21è¡Œ` ä¹‹åè·³åˆ°å¦å¤–ä¸€ä¸ªç•Œé¢: 

![mainå‡½æ•°è¢«è°ƒç”¨](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/SF_main__CRTStartup_mainCRTStartup.webp)

å‘ç°, `main` å‡½æ•°å¹¶ä¸æ˜¯ç›´æ¥è¢«è®¡ç®—æœºè°ƒç”¨çš„, è€Œæ˜¯ç”±å¦å¤–ä¸€ä¸ªå‡½æ•°æ‰€è°ƒç”¨

å‘ä¸Šç¿»é˜…ä»£ç , èƒ½çœ‹åˆ° main å‡½æ•°å…¶å®æ˜¯åœ¨ `__mainCRTStartup` å‡½æ•°ä¸­è¢«è°ƒç”¨

è€Œ `__mainCRTStartup` å‡½æ•°, åˆåœ¨ `mainCRTStartup` å‡½æ•°ä¸­è¢«è°ƒç”¨

![__mainCRTStartupè¢«è°ƒç”¨](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/SF_mainCRTStartup_return.webp)

æ‰€ä»¥ åœ¨è°ƒç”¨ `main` å‡½æ•°ä¹‹å‰, å…¶å®å·²ç»è°ƒç”¨äº†ä¸¤ä¸ªå‡½æ•°, ä¹Ÿå·²ç»åˆ›å»ºäº†ä¸¤ä¸ªå‡½æ•°çš„æ ˆå¸§ã€‚ä½†æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°çš„æ ˆå¸§åˆ›å»ºçš„è¿‡ç¨‹å¹¶ä¸å®¹æ˜“è¢«çœ‹åˆ°, æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è§‚å¯Ÿ main å‡½æ•°çš„æ ˆå¸§çš„åˆ›å»ºæ¥è¯¦ç»†äº†è§£æ ˆå¸§çš„åˆ›å»ºã€‚

é‡æ–°å›åˆ°, å…‰æ ‡åˆšæŒ‡å‘ `main` å‡½æ•°çš„æ—¶å€™, `è½¬åˆ°åæ±‡ç¼–`: 

![åæ±‡ç¼–](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/SF_Main_Stack_Frames.webp)

å³è¾¹ `åæ±‡ç¼–çª—å£çš„ä»£ç ` , å…¶å®å°±æ˜¯ `main` å‡½æ•°ä¸­, `ä»å‡½æ•°æ ˆå¸§åˆ›å»º, åˆ° main å‡½æ•°ç»“æŸ` çš„æ•´ä¸ªæ“ä½œåŠé¡ºåºã€‚

ä»¥åŠ¨ç”»å½¢å¼æ¼”ç¤º: 
 1. `main` å‡½æ•°è°ƒç”¨ä¹‹å‰, `mainCRTStartup` å’Œ `__mainCRTStartup` å‡½æ•°çš„æ ˆå¸§åˆ›å»º(æ— è¯¦ç»†å†…å®¹): 

    ![|large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/SF_MAINSRTSTARTUP_PUSH.gif)

 2. è¿›å…¥ `main` å‡½æ•°: 

    > 1. `(push ebp)` å‹æ ˆ, å‹å…¥å†…å®¹æ˜¯ `ebp` æŒ‡å‘çš„åœ°å€`(ä¸ºä¿å­˜å½“å‰ ebp å†…å®¹)``
    >     `ps: å‹æ ˆä¹‹å, esp(æ ˆé¡¶æŒ‡é’ˆ)è‡ªåŠ¨æŒ‡å‘æ ˆé¡¶`
    > 2. `(mov  ebp,esp)` å°† `ebp` æŒ‡å‘ `esp` çš„åœ°å€( å°† `esp` èµ‹äºˆ `ebp`)

    æ­¤æ—¶, `ebp` å’Œ `esp` çš„å®é™…å˜åŒ–ä¸º: 

    > æœªæ‰§è¡Œ :
    >
    > ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/push_esp_ebp_change.webp)
    >
    > æ‰§è¡Œ `push ebp` :
    >
    > ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/pushA_esp_ebp_change.webp)
    >
    > æ‰§è¡Œ `mov ebp,esp` :
    >
    > ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/mov_esp_ebp_change.webp)
    >
    > ![å‹æ ˆebp, è°ƒæ•´ |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/push_epb.gif)

3. æ­¤æ—¶, åæ±‡ç¼–ä¸­çš„è¯­å¥å…‰æ ‡æŒ‡å‘äº† 

    `sub esp,0E4h`

    ![next_esp_sub |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/sub_esp.webp)

    å³ä¸‹ä¸€å¥æ‰§è¡ŒæŒ‡ä»¤çš„å°±æ˜¯ `sub esp,0E4h`

    > æ±‡ç¼–è¯­è¨€: `sub ç›¸å‡`
    >
    > `sub esp,0E4h` æŒ‡ `esp = esp - 0E4h`
    >
    > `0E4h` æ˜¯åå…­è¿›åˆ¶æ•°, è½¬æ¢æˆåè¿›åˆ¶ä¸º 228:
    >
    > ![0E4h |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/0E4h.webp)

    æ‰§è¡Œ`sub esp,0E4h` çš„å˜åŒ–: 

    > æœªæ‰§è¡Œ: 
    >
    > ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/No_sub.webp)
    >
    > æ‰§è¡Œ `sub esp,0E4h`: 
    >
    > ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/sub_esp_change.webp)

    ![sub esp,0E4h |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/sub_esp_0E4h.gif)

    æ‰§è¡Œä¹‹å, `esp` å’Œ `ebp` ä¹‹é—´ä¼š å­˜åœ¨ä¸€å—ç”±å…¶æ–°ç»´æŠ¤çš„ç©ºé—´

    è€Œè¿™æ®µç©ºé—´å…¶å®å°±æ˜¯ä¸º `main` å‡½æ•°é¢„å¼€è¾Ÿçš„ç©ºé—´

    æŸ¥çœ‹åœ°å€: 

    ![For_main_space |medium](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/For_main_space.webp)

    å³: ä» `0x00AFF8A4` åˆ° `0x00AFF988` å°±æ˜¯ä¸º `main` å‡½æ•°ä¸å¼€è¾Ÿçš„ç©ºé—´

    ä¹Ÿè¢«æˆä¸º `main` å‡½æ•°çš„æ ˆå¸§ã€‚

    ä½†æ˜¯, è¿™é‡Œå¹¶ä¸æ˜¯å‡½æ•°æ ˆå¸§åˆ›å»ºçš„ç»“æŸã€‚

4. ç»§ç»­æ‰§è¡Œæ±‡ç¼–æŒ‡ä»¤, å…‰æ ‡ç»§ç»­ç§»åŠ¨: 

    ![Push_ebx_esi_edi |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Push_ebx_esi_edi.webp)

    ![Save_ebx_esi_edi |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Save_ebx_esi_edi.gif)

    ä¿å­˜äº†å¯„å­˜å™¨`ebx` `esi` `edi`

5. æŒ‡ä»¤ç»§ç»­æ‰§è¡Œ: 

    > 1. æ‰§è¡Œ`lea edi,[ebp-0E4h]`:
    >
    >     ![lea_edi |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/lea_edi.webp)
    >
    >       è¿™é‡Œçš„ `ebp-0E4h` åœ°å€, ç»è¿‡å¯¹æ¯”, å°±æ˜¯ é¢„å¼€è¾Ÿçš„ `main` å‡½æ•°æ ˆå¸§çš„æ ˆé¡¶åœ°å€`(0x00AFF8A4)`
    >
    >     > æ±‡ç¼–æŒ‡ä»¤ : `lea(Load effect address)`   åŠ è½½æœ‰æ•ˆåœ°å€
    >     > `lea edi,[ebp-0E4h]`  å³ä¸º: åŠ è½½æœ‰æ•ˆåœ°å€ `ebp-0E4h` è‡³å¯„å­˜å™¨`edi`
    >
    > 2. æ‰§è¡Œ `mov ecx,39h` å’Œ `mov eax,0CCCCCCCCh`
    >
    >     ![No_mov_ecx_eax |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/No_mov_ecx_eax.webp)
    >
    >     ğŸ‘‡ğŸ‘‡ğŸ‘‡
    >
    >     ![mov_ecx_eax |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/mov_ecx_eax.webp)
    >
    >     å¯„å­˜å™¨ `ecx` å­˜å…¥ `åå…­è¿›åˆ¶ 39(åè¿›åˆ¶ 57)`
    >
    >     å¯„å­˜å™¨ `eax` å­˜å…¥`0xCCCCCCCC`
    >
    > 3. æ‰§è¡Œ `rep_stos  dword_ptr_es:[edi]`:
    >
    >     ![rep_stos |medium](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/rep_stos_change.webp)
    >
    >     æ‰§è¡Œä¹‹å, ä» `0x00AFF988 - 4` åˆ° `0x00AFF8A4` çš„`(æ¯4å­—èŠ‚)`æ‰€æœ‰å†…å®¹éƒ½è¢«è®¾ç½®ä¸ºäº† `0xCCCCCCCC` , å³ å¼€è¾Ÿçš„`main` æ ˆå¸§ä¸­çš„æ‰€æœ‰å†…å®¹è¢«è®¾ç½®ä¸º `0xCCCCCCCC` 
    >
    >     æ±‡ç¼–æŒ‡ä»¤:
    >
    >     ```
    >     lea         edi,[ebp-0E4h]  
    >     mov         ecx,39h  
    >     mov         eax,0CCCCCCCCh  
    >     rep stos    dword ptr es:[edi]
    >     ```
    >
    >     è¿™ä¸€æ®µæ±‡ç¼–æŒ‡ä»¤ä¸­æœ€åä¸€å¥
    >
    >     `rep_stos    dword_ptr_es:[edi]`
    >
    >     `rep` :  é‡å¤ä¸Šé¢æŒ‡ä»¤,  å³ 
    >
    >     ```
    >     lea         edi,[ebp-0E4h]  
    >     mov         ecx,39h  
    >     mov         eax,0CCCCCCCCh
    >     ```
    >
    >     å¯„å­˜å™¨ `ecx` ä¸­çš„å€¼, å³ä¸ºé‡å¤çš„æ¬¡æ•°
    >
    >     `stos` : å°† `eax` ä¸­çš„å€¼æ‹·è´åˆ° `edi` æŒ‡å‘çš„åœ°å€
    >
    >     > æŒ‡ä»¤æ‰§è¡Œæ—¶, é»˜è®¤ `edi` ä¸­çš„åœ°å€, æ˜¯å¢å¤§çš„(å‘é«˜åœ°å€å¢é•¿)ã€‚æ‰€ä»¥, ä¼šä»`edi [ebp-0E4h(0x00AFF8A4)]` æ¯4å­—èŠ‚çš„å¢é•¿, å¢é•¿åˆ° `0x00AFF988` å…± 57æ¬¡(å¯„å­˜å™¨ `ecx` ä¸­å­˜å…¥çš„æ•°æ®)
    >
    > `main` å‡½æ•°æ ˆå¸§ä¸­æ‰€æœ‰å†…å®¹è¢« è®¾ç½®ä¸ºäº† `0xCCCCCCCC`
    >
    > é‚£ä¹ˆ åœ¨ `main` å‡½æ•°ä¸­ å®šä¹‰å±€éƒ¨å˜é‡ è€Œä¸åˆå§‹åŒ–
    >
    > å±€éƒ¨å˜é‡å°±ä¼šè¡¨ç¤ºéšæœºå€¼
    >
    > æ‰€ä»¥ è¾“å‡ºä¸€ä¸ªæœªåˆå§‹åŒ–çš„å±€éƒ¨å˜é‡, å¾ˆå¯èƒ½ä¼šå‡ºç°:
    >
    > ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/0xCCCCCCCC.webp)

åˆ°æ­¤, `main` å‡½æ•°æ ˆå¸§çš„é¢„åˆ›å»ºå…¨éƒ¨å®Œæˆï¼ˆåªæ˜¯é¢„åˆ›å»ºï¼‰ã€‚
æ¥ä¸‹æ¥å°±æ˜¯, å±€éƒ¨å˜é‡çš„åˆ›å»ºã€è°ƒç”¨å‡½æ•°æ ˆå¸§çš„åˆ›å»ºã€å‡½æ•°ä¼ å‚ã€å‡½æ•°è¿”å›ç­‰ã€‚


# å±€éƒ¨å˜é‡æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿè°ƒç”¨å‡½æ•°ç©¶ç«Ÿæ˜¯å¦‚ä½•ä¼ å‚çš„ï¼Ÿ
ä»¥ä¸Š, è¯¦ç»†åˆ†æäº† `main` å‡½æ•°æ ˆå¸§åœ¨å†…å­˜ä¸­åˆ›å»ºçš„è¿‡ç¨‹ã€‚
åˆ›å»ºå®Œæˆä¹‹å, å°±ä¼šæŒ‰ç…§é¡ºåºæ‰§è¡Œ `main` å‡½æ•°ä¸­çš„å‡½æ•° æˆ– è¯­å¥ã€‚


æ¥ä¸‹æ¥, å°±æ˜¯å±€éƒ¨å˜é‡åœ¨æ ˆå¸§ä¸­çš„åˆ›å»º å’Œ å‡½æ•°è¢«è°ƒç”¨æ—¶ä¼ å‚çš„å®ç°: 

## å±€éƒ¨å˜é‡åœ¨æ ˆå¸§ä¸­çš„åˆ›å»º
å…ˆåœ¨åæ±‡ç¼–çª—å£ä¸­, å³é”®é€‰æ‹©æ˜¾ç¤ºç¬¦å·å, å¯ä»¥çœ‹åˆ°: 

![|medium](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Show_char_name.webp)

å…³é—­å­—ç¬¦ååˆ™ä¼šæ˜¾ç¤ºåœ°å€: 

![Local_variables_creat_front |inline](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Local_variables_creat_front.webp)

> `dword ptr` è¡¨ç¤ºåœ°å€å†…å®¹ä¸ºåŒå­—`(4å­—èŠ‚)`æ•°æ®

è§‚å¯Ÿæ±‡ç¼–ä»£ç , å¯¹ å±€éƒ¨å˜é‡ `a`ã€ `b`ã€ `c` çš„åˆ›å»ºåŠåˆå§‹åŒ–æ˜¯ä» åœ°å€`ebp-8` å¼€å§‹çš„ã€‚
ä»£ç å‘ä¸‹æ‰§è¡Œ: 

![Local_variables_creat](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Local_variables_creat.webp)

![Local_variables_creat |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Local_variables_creat.gif)

å±€éƒ¨å˜é‡çš„åˆ›å»ºç›¸å¯¹ç®€å•, ä¸€å¼ åŠ¨å›¾å°±å¯ä»¥ç†è§£ã€‚

## å‡½æ•°è¢«è°ƒç”¨æ—¶çš„ä¼ å‚ åŠ è¢«è°ƒç”¨å‡½æ•°æ ˆå¸§çš„åˆ›å»º
è°ƒç”¨éœ€è¦ä½¿ç”¨å‚æ•°çš„å‡½æ•°æ—¶, éœ€è¦ä¼ å…¥å­˜åœ¨çš„å±€éƒ¨å˜é‡, ä½œä¸ºå‡½æ•°çš„å‚æ•°ã€‚
ä½†æ˜¯, è¢«ä¼ å…¥å‡½æ•°çš„å‚æ•°, åœ¨å‡½æ•°ä¸­éƒ½è¢«ç§°ä¸º `å½¢å‚`, åœ¨è¢«è°ƒç”¨å‡½æ•°ä¸­ ç›´æ¥æ”¹å˜ å¹¶ä¸èƒ½çœŸæ­£æ”¹å˜åŸæ¥çš„å˜é‡, è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ

çœŸæ­£çš„åŸå› , å°±åœ¨è¿™é‡Œ: 

---

![|inline](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add_No.webp)

å…ˆåˆ†ææ±‡ç¼–ä»£ç : 

> ```
> mov        eax,dword ptr [ebp-14h]
> push       eax
> mov        ecx,dword ptr [ebp-8]
> push       ecx
> ```
> å°† `ebp-14h` åœ°å€å¤„çš„åŒå­—çš„å€¼ï¼ˆå³å˜é‡ b çš„å€¼ï¼‰å­˜å…¥ å¯„å­˜å™¨ `eax`, å‹æ ˆå­˜å…¥ `eax` , å‹å…¥ä½ç½®æ˜¯: `0x00AFF894`
> å°† `ebp-8` åœ°å€å¤„çš„åŒå­—çš„å€¼ï¼ˆå³å˜é‡ a çš„å€¼ï¼‰å­˜å…¥ å¯„å­˜å™¨ `ecx`, å‹æ ˆå­˜å…¥ `ecx`, å‹å…¥ä½ç½®æ˜¯: `0x00AFF890`

æ‰§è¡Œä¹‹åå†…å­˜ä¸­çš„å˜åŒ–: 

![å½¢å‚çš„ä¼ å‚](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/eax_ecx_a_b_push.webp)

`è¿™ä¸¤ä¸ªæ­¥éª¤, å…¶å®å°±æ˜¯å½¢å‚çš„åˆ›å»º, æˆ–è€…è¯´è°ƒç”¨å‡½æ•°æ—¶çš„ä¼ å‚æ“ä½œ`
`(è¢«è°ƒç”¨å‡½æ•°ç©¶ç«Ÿæ˜¯å¦‚ä½•ä½¿ç”¨å½¢å‚çš„å†…å®¹åœ¨ä¸‹è¾¹)`
ä¹Ÿå°±æ˜¯è¯´, å½¢å‚çš„åˆ›å»ºå…¶å®æ˜¯åœ¨ `main` å‡½æ•°çš„æ ˆå¸§ä¸­åˆ›å»ºçš„ã€‚

æ±‡ç¼–æŒ‡ä»¤ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼ˆæ³¨æ„: æ‰§è¡Œ `call` æŒ‡ä»¤æ—¶, `(VSç¯å¢ƒ)`æŒ‰`F11` è¿›å…¥å‡½æ•°å†…éƒ¨ ï¼‰: 
> `call` æŒ‡ä»¤, åœ¨è¿™é‡Œçš„ä½œç”¨æ˜¯: 
> 1. å°† `call` æŒ‡ä»¤çš„ä¸€ä¸‹æ¡æŒ‡ä»¤çš„åœ°å€`(00911F00)`å‹å…¥æ ˆä¸­
> 2. ç„¶åè·³è½¬è‡³ åè¾¹çš„åœ°å€`(009111E0)`çš„ä»£ç å¤„

![Call æŒ‡ä»¤æ‰§è¡Œ](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/call.webp)

åˆ°æ­¤æ—¶å†…å­˜å˜åŒ–: 

![Virtual_variables_creat |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Creat_Virtual_parameters.gif)

> `jmp` æŒ‡ä»¤: æ— æ¡ä»¶è·³è½¬è‡³ åè¾¹çš„åœ°å€å¤„
> å³åœ¨æ­¤æŒ‡ä»¤ä¸­, è·³è½¬è‡³`00911A40` å¤„

æ‰§è¡Œ `jmp` : 

![jmp Add |inline](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/jmp_add.webp)

æ‰§è¡Œ `jmp` ä¹‹å, è¿›å…¥ `Add å‡½æ•°`, ä¼šå‘ç°ä¸€æ®µç†Ÿæ‚‰çš„æŒ‡ä»¤, å’Œè¿›å…¥ `main` å‡½æ•°æ—¶çš„å‰å‡ è¡ŒæŒ‡ä»¤ç›¸ä¼¼ã€‚
è¿™æ®µæŒ‡ä»¤å°±æ˜¯ `Add` å‡½æ•°é¢„å¼€è¾Ÿæ ˆå¸§çš„æŒ‡ä»¤ï¼ˆä¸å†åˆ†æï¼‰, ç›´æ¥çœ‹å›¾: 
1. å…ˆå‹æ ˆ, å‹å…¥çš„æ˜¯ ç»´æŠ¤ `main` å‡½æ•°æ ˆå¸§æ—¶çš„`ebp`  : 

    ![Addå‡½æ•°å‹å…¥ç»´æŠ¤mainçš„ebp |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add_ebp_Push.webp)

2. è¿ç»­æ‰§è¡ŒæŒ‡ä»¤, é¢„åˆ›å»ºåŠå¤„ç† `Add` å‡½æ•°æ ˆå¸§: 

    ![Add_å‡½æ•°æ ˆå¸§åˆ›å»º |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add_SF_Creat.webp)

![Add_SF_Create |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add_SF_Creat.gif)

ä»¥ä¸Šæ˜¯ `Add` å‡½æ•°æ ˆå¸§çš„åˆ›å»ºè¿‡ç¨‹ã€‚


## è¢«è°ƒç”¨å‡½æ•°å½¢å‚çš„ä½¿ç”¨

è‡ªå®šä¹‰çš„ `Add` å‡½æ•°, ç›®çš„æ˜¯æ±‚ä¸¤ä¸ª`int` ç±»å‹æ•´æ•°çš„å’Œ, è¿”å›å€¼ä¹Ÿæ˜¯ `int` ç±»å‹ã€‚

è§‚å¯Ÿã€å¯¹æ¯”æ±‡ç¼–ä»£ç : 

> ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Use_Virtual_variables.webp)
>
> 1. `z` , æ˜¯åœ¨ `Add` å‡½æ•°æ ˆå¸§å†…åˆ›å»ºçš„å±€éƒ¨å˜é‡, å¯¹åº”çš„åœ°å€æ˜¯ `ebp-8`, å³ä» `ebp(æ­¤æ—¶ç»´æŠ¤Addæ ˆå¸§çš„æ ˆåº•æŒ‡é’ˆ)` å‘ä½åœ°å€åç§» `8 å­—èŠ‚`, å‘ç°åœ¨ `Add` æ ˆå¸§å†…éƒ¨ã€‚
>
>     ![ |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add_Creat_VR.webp)
>
> 2. `x`ã€`y` åˆ†åˆ«å¯¹åº” : `ebp+8` ã€`ebp+0Ch`
>     å³ä» `ebp` å‘é«˜åœ°å€åç§» `8 å­—èŠ‚` å’Œ `12 å­—èŠ‚`, å¾ˆæ˜æ˜¾ä¸åœ¨ `Add` å‡½æ•°æ ˆå¸§å†…, ç©¶ç«Ÿåœ¨å“ªï¼Ÿ
>     
>     ![ |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add_VR_address.webp)
>     
>     åˆ†æä¹‹åå‘ç°, `Add` å‡½æ•°è°ƒç”¨çš„å½¢å‚ å…¶å®å°±æ˜¯ä¹‹å‰(å³å°†è¿›å…¥`Add`å‡½æ•°æ—¶), æ‰§è¡Œè¿™ä¸€æ®µä»£ç æ—¶å‹æ ˆçš„å†…å®¹: 
>     
>     > ```
>     > mov        eax,dword ptr [ebp-14h]
>     > push       eax
>     > mov        ecx,dword ptr [ebp-8]
>     > push       ecx
>     > ```
>     >
>     > å°† `ebp-14h` åœ°å€å¤„çš„åŒå­—çš„å€¼ï¼ˆå³å˜é‡ `b` çš„å€¼ï¼‰å­˜å…¥ å¯„å­˜å™¨ `eax`, å‹æ ˆå­˜å…¥ `eax`, å‹å…¥ä½ç½®æ˜¯: `0x00AFF894`
>     > å°† `ebp-8` åœ°å€å¤„çš„åŒå­—çš„å€¼ï¼ˆå³å˜é‡ `a` çš„å€¼ï¼‰å­˜å…¥ å¯„å­˜å™¨ `ecx`, å‹æ ˆå­˜å…¥ `ecx`, å‹å…¥ä½ç½®æ˜¯: `0x00AFF890`
>
> 3. æ‰€ä»¥
>
>     `å‡½æ•°çš„å½¢å‚å…¶å®æ—©åœ¨mainå‡½æ•°æ ˆå¸§ä¸­å°±å·²ç»åˆ›å»ºå¥½å¹¶ä¸”å­˜å‚¨åœ¨ä¸€ä¸ªä½ç½®, å¹¶ä¸æ˜¯è¿›å…¥å‡½æ•°æ‰åˆ›å»ºçš„, å‡½æ•°è¦ä½¿ç”¨å½¢å‚ç›´æ¥åœ¨å­˜å‚¨çš„é‚£ä¸ªåœ°å€æ‹¿å°±å¯ä»¥äº†, è¿™å°±æ˜¯ åœ¨å‡½æ•°ä¸­æ”¹å˜å½¢å‚ä¸ä¼šå½±å“åŸå˜é‡ çš„åŸå› `

è§‚å¯Ÿè¿‡å, æ‰§è¡Œç›¸åŠ çš„è¯­å¥: 

![](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add.webp)

ç›¸åŠ æ“ä½œå®Œæˆ

ä½†æ˜¯éœ€è¦å°†ç›¸åŠ çš„ç»“æœä½œä¸ºè¿”å›å€¼è¿”å›, å¹¶ä¸”é‡æ–°å›åˆ°`main` å‡½æ•°ä¸­, è¿™ä¸ªå‡½æ•°æ‰ç®—æ‰§è¡Œç»“æŸ.

è¿”å›æ“ä½œå…·ä½“æ˜¯å¦‚ä½•è¿›è¡Œçš„å‘¢ï¼Ÿ

##  å‡½æ•°è¿”å›
å‡½æ•°è¿”å›å¹¶æ²¡æœ‰çœ‹ä¸Šå»é‚£ä¹ˆç®€å•: 

![|medium](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Return_Add.webp)

`return z;` è¯­å¥ä¹‹å, å…¶å®éƒ½æ˜¯å‡½æ•°è¿”å›éœ€è¦è¿›è¡Œçš„æ“ä½œã€‚

1. é¦–å…ˆæ˜¯, `return z;`

    è¿”å›å€¼æ“ä½œæ˜¯, `mov  eax,dword ptr [ebp-8]`

    å°† `ebp-8(z)` å¤„çš„ä¸¤å­—`(4å­—èŠ‚)` çš„å€¼å­˜å…¥ å¯„å­˜å™¨ `eax`

    è¿”å› `z` çš„æ“ä½œ, å…¶å®å°±æ˜¯å°† `z` çš„å€¼, å­˜å…¥äº†å¯„å­˜å™¨ä¸­ã€‚

    å½“å‡½æ•°ä½¿ç”¨å®Œå, å±€éƒ¨å˜é‡ä¼šè¢«é”€æ¯, ä½†æ˜¯å¯„å­˜å™¨åœ¨CPUä¸­æ˜¯ä¸ä¼šè¢«é”€æ¯çš„ã€‚

    æ‰€ä»¥å°† å±€éƒ¨å˜é‡ `z` çš„å€¼ å­˜æ”¾åœ¨å¯„å­˜å™¨ä¸­, å°±èƒ½è¾¾åˆ°è¿”å› `z` çš„å€¼ çš„æ•ˆæœ

    ![return_z  |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/return_z.webp)

2. å†æŒ‰é¡ºåºå°†:

   åœ¨è¿›å…¥ `Add` å‡½æ•°å å‹æ ˆçš„ `edi`, `esi`, `ebx` ä¸‰ä¸ªå†…å®¹é€€æ ˆ

   ![pop_edi_esi_ebx |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Add_pop_edi_esi_ebx.webp)

3. ç„¶åå°† `ebp` çš„å€¼ ç»™ `esp`, å½“ `esp` çš„å€¼å˜ä¸º `ebp` çš„å€¼çš„æ—¶å€™, `Add` å‡½æ•°æ ˆå¸§çš„ç»´æŠ¤å°±ç»“æŸäº†ã€‚`Add` å‡½æ•°æ ˆå¸§çš„ç©ºé—´å°±ä¼šè¿˜ç»™å†…å­˜

    ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/image-20230820115311609.webp)

4. å†ç„¶åå°±æ˜¯ `pop   ebp`

    `pop  ebp`  ä¸ ä¸€èˆ¬ `pop` å…¶ä»–å†…å®¹ä¸åŒ, `pop ebp` è¿˜ä¼šå°†è¿™é‡Œéœ€è¦å¼¹å‡ºçš„ `ebp` çš„å€¼ ç»™ å¯„å­˜å™¨ `ebp`

    ![pop_ebp |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/pop_ebp.webp)

    æ­¤æ—¶, `esp` å’Œ `ebp` ä¸¤ä¸ªç»´æŠ¤æ ˆå¸§çš„å¯„å­˜å™¨, å°±åˆå»ç»´æŠ¤ `main` å‡½æ•°æ ˆå¸§äº†ã€‚

    è¿™æ•´ä¸ªè¿‡ç¨‹çš„åŠ¨ç”»

    ![|large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/Destory_Add_SF.gif)

5. æœ€åä¸€æ­¥å°±æ˜¯ `ret` æŒ‡ä»¤

    å½“ `Add` å‡½æ•°ä½¿ç”¨ç»“æŸä¹‹å, æ±‡ç¼–ä»£ç åº”è¯¥ç»§ç»­å›åˆ° `main` å‡½æ•°ä¸­çš„ `call` æŒ‡ä»¤çš„ä¸‹ä¸€æ¡è¯­å¥çš„åœ°æ–¹: 

    å³è¿™é‡Œ: 

    ![return åº”è¯¥å›åˆ°çš„ä½ç½® |medium](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/return_call.webp)

    é‚£ä¹ˆæ€ä¹ˆæ‰èƒ½å›åˆ°è¿™é‡Œå‘¢ï¼Ÿ

    å›æƒ³ä¸€ä¸‹, åœ¨ `esp` å’Œ `ebp` é‡æ–°ç»´æŠ¤`main` å‡½æ•°æ ˆå¸§çš„æ—¶å€™, `esp` æŒ‡å‘çš„åœ°å€, å…¶å®å°±æ˜¯ä¹‹å‰ `call` æŒ‡ä»¤æ‰§è¡Œæ—¶, å‹æ ˆå‹å…¥çš„`call` æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€:

    ![retçš„åœ°å€ |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/ret_address.webp)

    `ret` æŒ‡ä»¤æ‰§è¡Œä¹‹å, ä¼šç›´æ¥æŠŠè¿™ä¸ªç©ºé—´å¼¹å‡ºæ ˆ, ç„¶åè¿”å›åˆ°è¿™ä¸ªç©ºé—´å­˜æ”¾çš„åœ°å€çš„æŒ‡ä»¤å¤„: 

    ![ret |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/ret.gif)

    ![|wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/ret_after.webp)

    è¿™äº›æ­¥éª¤æ‰§è¡Œä¹‹å, é€»è¾‘æˆåŠŸä» `Add` å‡½æ•°ä¸­è¿”å›åˆ° `main` å‡½æ•°ä¸­ã€‚

    ç»§ç»­æ‰§è¡Œä»£ç : 

    `add  esp,8`:

    ![esp+8 |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/add_esp.webp)

    `mov dword ptr [ebp-20h],eax`:

    ![ |wide](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/mov_eax_to_c.webp)

    ![esp+8-movC |large](https://dxyt-july-image.oss-cn-beijing.aliyuncs.com/esp%2B8-movC.gif)
    
    

ä»£ç èµ°åˆ°è¿™é‡Œ, å‡½æ•°æ ˆå¸§çš„å¤§éƒ¨åˆ†å†…å®¹éƒ½å·²ç»è®²çš„å¾ˆæ¸…æ¥šäº†ã€‚æœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œä¹Ÿå°±ç»“æŸäº†ã€‚

---

# ç»“æŸ

å†å›è¿‡å¤´æ¥çœ‹æ–‡ç« å¼€å¤´çš„é—®é¢˜: 
1. ä»€ä¹ˆæ˜¯å‡½æ•°æ ˆå¸§ï¼Ÿ

2. ç¨‹åºä¸­çš„å±€éƒ¨å˜é‡, æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ
3. ä¸ºä»€ä¹ˆå±€éƒ¨å˜é‡ä¸åˆå§‹åŒ–ä¼šæ˜¯éšæœºå€¼ï¼Ÿ
4. å‡½æ•°ä¼ å‚, ç©¶ç«Ÿæ˜¯å¦‚ä½•ä¼ å‚çš„ï¼Ÿ
5. å‡½æ•°çš„å½¢å‚å’Œå®å‚å­˜åœ¨ä»€ä¹ˆå…³ç³»ï¼Ÿ
6. å‡½æ•°æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ï¼Ÿ
7. å‡½æ•°è¢«è°ƒç”¨ä¹‹åæ˜¯å¦‚ä½•è¿”å›çš„ï¼Ÿ

å¦‚æœè¯»æ‡‚äº†æœ¬ç¯‡æ–‡ç« , å¯¹äºè¿™äº›é—®é¢˜åº”è¯¥æ˜¯æœ‰ä¸€ä¸ªæ¸…æ™°æ˜ç¡®çš„ç†è§£çš„ã€‚
å¸Œæœ›å¯ä»¥å¸®åˆ°å¤§å®¶ã€‚

---

è¿™ç¯‡æ–‡ç« , æ˜¯æå‡è‡ªæˆ‘ä¿®å…»ç¯‡çš„ç¬¬ä¸€ç¯‡æ–‡ç« ã€‚
æ–‡ç« çš„å†…å®¹ä¸»è¦æ¥æºäº `ã€Šç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»----â€œé“¾æ¥ã€è£…è½½ä¸åº“â€ã€‹` ä»¥åŠ åšä¸»è‡ªå·±çš„è°ƒè¯•ä¸æ€»ç»“ã€‚

æ„Ÿè°¢ï¼ï¼ï¼
ï¼ˆç”»å›¾çœŸçš„è€—æ—¶é—´ï¼‰



