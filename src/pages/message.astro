---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { Icon } from "astro-icon/components";
import MainCard from "@/components/MainCard.astro";
---

<BaseLayout title="Message">
  <MainCard
    image="/bg6.jpg"
    title="ç•™è¨€"
    description="Youngestar çš„ç•™è¨€æ¿:ç•™ä¸‹æƒ³è¯´çš„è¯æˆ–è€…ç»™å‡ºä¸€äº›äº›å»ºè®®ğŸ”–"
    textOverlay="FRIENDS"
    infoIcon="lucide:mails"
  >
    <head>
      <link rel="stylesheet" href="https://unpkg.com/@waline/client@latest/dist/waline.css" />
    </head>
    <div class="space-y-10">
      <!-- Friends Section -->
      <section>
        <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
          <Icon name="lucide:message-square-text" class="w-6 h-6 text-primary" />
          <span>ç•™è¨€æ¿</span>
        </h2>

        <div class="space-y-10">
          <!-- åŠ è½½çŠ¶æ€æç¤º -->
          <div id="waline-loading" class="text-center py-8">
            <div class="loading loading-spinner text-primary"></div>
            <p class="mt-2 text-sm">è¯„è®ºåŠ è½½ä¸­...</p>
          </div>

          <section>
            <!-- ç¡®ä¿å®¹å™¨å…ƒç´ å­˜åœ¨ -->
            <div id="waline" style="display: none;"></div>
          </section>

          <script is:inline define:vars={{ walineServerURL: import.meta.env.PUBLIC_WALINE_SERVER }}>
            let walineInstance = null;
            const MAX_RETRY = 3;
            let retryCount = 0;

            const initWaline = async () => {
              try {
                // ç¡®ä¿å®¹å™¨å­˜åœ¨
                const container = document.querySelector("#waline");
                if (!container) {
                  throw new Error("Waline container not found");
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                document.getElementById("waline-loading").style.display = "block";
                container.style.display = "none";

                // æ¸…ç†æ—§å®ä¾‹
                if (walineInstance) {
                  walineInstance.destroy();
                  container.innerHTML = "";
                }

                // åŠ¨æ€åŠ è½½ Waline
                const { init } = await import("https://unpkg.com/@waline/client/dist/waline.js");

                walineInstance = init({
                  el: "#waline",
                  serverURL: walineServerURL,
                  // å…¶ä»–é…ç½®...
                });

                // éšè—åŠ è½½çŠ¶æ€
                document.getElementById("waline-loading").style.display = "none";
                container.style.display = "block";
              } catch (error) {
                console.error("Waline åˆå§‹åŒ–å¤±è´¥:", error);

                if (retryCount < MAX_RETRY) {
                  retryCount++;
                  setTimeout(initWaline, 2000 * retryCount);
                } else {
                  document.getElementById("waline-loading").innerHTML = `
              <div class="alert alert-error mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>è¯„è®ºåŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–ç¨åå†è¯•</span>
              </div>
            `;
                }
              }
            };

            // å¯åŠ¨åˆå§‹åŒ–
            const startInit = () => {
              if (document.getElementById("waline")) {
                initWaline();
              } else {
                setTimeout(startInit, 100);
              }
            };

            // å¤šç§è§¦å‘æ–¹å¼
            if (document.readyState === "complete") {
              startInit();
            } else {
              window.addEventListener("DOMContentLoaded", startInit);
            }

            document.addEventListener("astro:after-swap", startInit);
            window.addEventListener("popstate", startInit);
          </script>
        </div>

        <div class="divider my-8">
          <Icon name="lucide:heart" class="w-10 h-10 text-primary" />
        </div>

        <div class="text-center">
          <p class="text-base-content/80 mb-4">ä¸ºåšå®¢æ¨¡æ¿çš„ä½œè€…åšè´¡çŒ®!</p>
          <a
            href="https://github.com/EveSunMaple/Frosti"
            target="_blank"
            rel="noopener noreferrer"
            class="btn btn-primary gap-2"
          >
            <Icon name="lucide:github" class="w-5 h-5" />
            <span>Contribute on GitHub</span>
          </a>
        </div>
      </section>
    </div>
  </MainCard>

  <style>
    /* å…¨å±€ CSS */
    :root {
      --waline-theme-color: #27ae60; /* ä¸»é¢˜è‰² */
      --waline-active-color: #2ecc71; /* æ¿€æ´»è‰² */
      --waline-text-color: #34495e; /* æ–‡å­—è‰² */
      --waline-bgcolor: #f8f9fa; /* èƒŒæ™¯è‰² */
      --waline-border: 1px solid #e3e8f7; /* è¾¹æ¡† */
      --waline-info-bgcolor: #f8f9fa; /* ä¿¡æ¯æ èƒŒæ™¯ */
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --waline-text-color: rgba(255, 255, 255, 0.8);
        --waline-bgcolor: #1a1a1a;
        --waline-border-color: #333;
      }
    }
  </style>
</BaseLayout>
